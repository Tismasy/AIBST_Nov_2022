---
title: "OBDS Gene Set Enrichment and Pathway Analysis Practical"
author: "Charlie George"
date: "15/10/2021"
output: html_document
---

This is the pathway analysis practical of the OBDS course 
- The first part of this pracical is using gprofiler to perform ORA on output dataset of differentially expressed genes from DESeq2

# load packages 
```{r}
# load librarys

library(tidyverse)
library(gprofiler2)
```

# Read in our tables from this morning in a new Rmd file
```{r}
# read in files from this morning 

# 1. all results (this was filtered to remove non DE genes in our DESeq2 list so only contains genes expressed in our samples) -> call this table 'all_genes_df'  - this will be our background
all_genes_df <- read.csv("CD8_vs_CD4_DE_results_lfcshrinkage.csv")

#filter out the genes which padj is NA 
all_genes_df_filtered <-  all_genes_df %>% filter(!(is.na(padj)))
# filter genes with padj == NA as they are lowly expressed and excluded from DE analysis 

# 2. all significant upregulated genes -> call this upreg_genes_df
upreg_genes_df <- read.csv("CD8_vs_CD4_DKO_DE_results_lfcshrinkage_0.05_log2FC1_up.csv")

# 3. all significant down regulated genes -> call this downreg_genes_df 
downreg_genes_df <- read.csv("CD8_vs_CD4_DKO_DE_results_lfcshrinkage_0.05_log2FC1_down.csv")

# Check the dimensions of each of your dataframes using dim()
dim(upreg_genes_df) # should be 915
dim(downreg_genes_df) # should be 1204
dim(all_genes_df_filtered) # should be 17729


```

```{r}
# from each of these dataframes get a vector of the ensembl ids 
all_gene_ids <- all_genes_df_filtered %>% pull(ensembl_gene_ids)
    
upreg_gene_ids <- upreg_genes_df %>% pull(ensembl_gene_ids)
    
downreg_gene_ids <- downreg_genes_df %>% pull(ensembl_gene_ids)
```


code to run FGSEA
we will use the all_genes_df_filtered object we already created

For more details look at this vignette : https://stephenturner.github.io/deseq-to-fgsea/
or the FGSEA official vignette: https://bioconductor.org/packages/release/bioc/vignettes/fgsea/inst/doc/fgsea-tutorial.html  
to get other genesets like GO/MSigDB genesets in R and for different species use msigdbr : https://cran.r-project.org/web/packages/msigdbr/vignettes/msigdbr-intro.html 

 DESeq2 to FGSEA
 
 All you’ll care about later on is the gene symbol and the Log2FoldChange. Get just those, and remove the NAs. Finally, if you have multiple Log2FC values for the same symbol, you’ll want to deal with that in some way. Here I’m just averaging them.
 

 
```{r}
all_genes_df_filtered_avg <- all_genes_df_filtered %>% 
  dplyr::select(gene_symbols,log2FoldChange) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(gene_symbols) %>% 
  summarize(log2FoldChange=mean(log2FoldChange))
all_genes_df_filtered_avg


```

We’re going to use the fgsea package for fast preranked gene set enrichment analysis (GSEA)

The fgsea() function requires a list of gene sets to check, and a named vector of gene-level statistics (log2FC), where the names should be the same as the gene names in the pathways list. First, let’s create our named vector of test statistics

See ?tibble::deframe for help here - 

deframe() converts two-column data frames to a named vector or list, using the first column as name and the second column as value.

```{r}
library(fgsea)
ranks <- deframe(all_genes_df_filtered_avg)
head(ranks, 20)
```
Let’s use the Hallmark gene set from MSigDB. Hallmark gene sets summarize and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDB collections and retaining genes that display coordinate expression.

you can either download a gmt symbols file directly from MSigDB or use misgidbr

As we have mouse species we will use msigdbr



```{r}
library(msigdbr)
```


```{r}

all_gene_sets = msigdbr(species = "Mus musculus")
head(all_gene_sets)

#There is a helper function to show the available species. Either scientific or common names are acceptable.
msigdbr_species()
```

You can retrieve data for a specific collection, such as the hallmark gene sets.

The msigdbr() function output is a data frame and can be manipulated using more standard method

```{r}
h_gene_sets = msigdbr(species = "mouse", category = "H")
```

Use the gene sets data frame for fgsea.

```{r}
hallmark_list = split(x = h_gene_sets$gene_symbol, f = h_gene_sets$gs_name)

```

Now we can run fgsea yay!
```{r}
fgseaRes <- fgsea(pathways=hallmark_list, stats=ranks, nperm=1000, maxSize=500)
```

tidy the result

```{r}
fgseaResTidy <- fgseaRes %>%
  as_tibble() %>%
  arrange(desc(NES))
```


show in a nice table
```{r}
fgseaResTidy %>% 
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>% 
  arrange(padj) %>% 
  DT::datatable()
```
Plot the normalized enrichment scores. Color the bar indicating whether or not the pathway was significant:

```{r, fig.height=5}
ggplot(fgseaResTidy, aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill=padj<0.05)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title="Hallmark pathways NES from GSEA") + 
  theme_minimal()
```

Beautiful! 